{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": 800,
  "height": 450,
  "title": {
    "text": {"expr": "'Fire Incidents by Australian State/Territory - Year: ' + (yearFilter || 'All Years')"},
    "fontSize": 16
  },
  "projection": { "type": "equirectangular" },
  "params": [
    {
      "name": "yearFilter",
      "value": null,
      "bind": {
        "input": "select",
        "options": [null, 2017, 2018, 2019, 2020, 2021],
        "labels": ["All Years", "2017", "2018", "2019", "2020", "2021"],
        "name": "Select Year: "
      }
    }
  ],
  "data": {
    "url": "data/Fire_For16-21_Attributes.csv"
  },
  "transform": [
    {
      "filter": "datum.FOR_CATEGO == 'Native forest' && datum.STATE != '' && datum.STATE != null && (datum.FIRE_1617 == 'U' || datum.FIRE_1617 == 'P' || datum.FIRE_1718 == 'U' || datum.FIRE_1718 == 'P' || datum.FIRE_1819 == 'U' || datum.FIRE_1819 == 'P' || datum.FIRE_1920 == 'U' || datum.FIRE_1920 == 'P' || datum.FIRE_2021 == 'U' || datum.FIRE_2021 == 'P')"
    },
    {
      "fold": [
        "FIRE_1617",
        "FIRE_1718",
        "FIRE_1819", 
        "FIRE_1920",
        "FIRE_2021"
      ],
      "as": ["YearColumn", "FireStatus"]
    },
    {
      "filter": "datum.FireStatus == 'U' || datum.FireStatus == 'P'"
    },
    {
      "calculate": "datum.YearColumn == 'FIRE_1617' ? 2017 : datum.YearColumn == 'FIRE_1718' ? 2018 : datum.YearColumn == 'FIRE_1819' ? 2019 : datum.YearColumn == 'FIRE_1920' ? 2020 : 2021",
      "as": "Year"
    },
    {
      "filter": "yearFilter == null || datum.Year == yearFilter"
    },
    {
      "aggregate": [
        { 
          "op": "count",
          "as": "FireCount"
        }
      ],
      "groupby": ["STATE", "FireStatus"]
    },
    {
      "pivot": "FireStatus",
      "value": "FireCount",
      "groupby": ["STATE"]
    },
    {
      "calculate": "datum.U || 0",
      "as": "UnplannedFires"
    },
    {
      "calculate": "datum.P || 0", 
      "as": "PlannedFires"
    },
    {
      "calculate": "datum.UnplannedFires + datum.PlannedFires",
      "as": "FireIncidents"
    },
    {
      "lookup": "STATE",
      "from": {
        "data": {"name": "stateNames"},
        "key": "code", 
        "fields": ["name"]
      }
    },
    {
      "lookup": "name",
      "from": {
        "data": {
          "url": "STE_2021_AUST_GDA2020.topojson",
          "format": { "type": "topojson", "feature": "STE_2021_AUST_GDA2020" }
        },
        "key": "properties.STE_NAME21"
      },
      "as": "geo"
    }
  ],
  "mark": { "type": "geoshape", "stroke": "white", "strokeWidth": 0.5 },
  "encoding": {
    "shape": { "field": "geo", "type": "geojson" },
    "color": {
      "field": "FireIncidents",
      "type": "quantitative",
      "title": "Total Fire Incidents",
      "scale": { "scheme": "orangered" }
    },
    "tooltip": [
      {
        "field": "name",
        "type": "nominal",
        "title": "State/Territory"
      },
      {
        "field": "FireIncidents",
        "type": "quantitative",
        "title": "Total Fire Incidents"
      },
      {
        "field": "UnplannedFires",
        "type": "quantitative",
        "title": "Unplanned Fires"
      },
      {
        "field": "PlannedFires",
        "type": "quantitative",
        "title": "Planned Fires"
      }
    ]
  },
  "datasets": {
    "stateNames": [
      {"code": "Qld", "name": "Queensland"},
      {"code": "NSW", "name": "New South Wales"},
      {"code": "Vic", "name": "Victoria"},
      {"code": "Tas", "name": "Tasmania"},
      {"code": "SA", "name": "South Australia"},
      {"code": "WA", "name": "Western Australia"},
      {"code": "NT", "name": "Northern Territory"},
      {"code": "ACT", "name": "Australian Capital Territory"}
    ]
  }
}